<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>現在地→宛先 ナビ自動起動（Google マップ）</title>
  <meta name="description" content="郵便番号または電話番号を入力して、Google マップでナビを自動起動するデモサイト" />
  <style>
    :root { --bg: #0b1020; --card:#121933; --text:#e9ecf1; --muted:#aab2c5; --accent:#72e4ff; }
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #1a2454, transparent),
                     radial-gradient(1000px 800px at 110% 10%, #0f1840, transparent), var(--bg);
         color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:720px;margin:0 auto;padding:32px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
          border:1px solid rgba(255,255,255,.1); border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,.35); padding:24px}
    h1{font-size:clamp(20px,3.6vw,28px); margin:0 0 12px; letter-spacing:.02em}
    p.lead{margin:.2rem 0 1rem;color:var(--muted)}
    form{display:grid; gap:14px; grid-template-columns: 1fr auto}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:14px;color:var(--muted)}
    input[type="text"]{flex:1; min-width:200px; font-size:16px; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
                        background:#0e1531; color:var(--text); outline:none}
    input[type="text"]::placeholder{color:#8fa0c3}
    select,button{font-size:16px; padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.18);
                  background:#0e1531; color:var(--text)}
    button.primary{background:linear-gradient(90deg, #29b6f6, #00e5ff); color:#0b1020; border:none; font-weight:700}
    button[disabled]{opacity:.55}
    .hint{font-size:13px; color:#94a2c7}
    .badge{display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#0e1531; border:1px solid rgba(255,255,255,.12); color:#cfe2ff}
    .status{font-size:13px; color:#cfe2ff}
    .stack{display:grid; gap:10px}
    hr{border:none; border-top:1px solid rgba(255,255,255,.12); margin:16px 0}
    .footer{opacity:.8; font-size:12px}
    a{color:#8ee7ff}
    input[type="tel"] {
  background-color: #0e1531; /* 好きな背景色に固定 */
  color: #e9ecf1;           /* 文字色も再指定 */
  -webkit-text-fill-color: #e9ecf1; /* iOS Safari 対策 */
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>現在地からナビ開始（Google マップ）</h1>
      <p class="lead">スマホの位置情報を ON にして、<strong>郵便番号</strong> または <strong>電話番号</strong> または <strong>店名</strong> または <strong>住所</strong> を入力 → <em>Google マップ</em> アプリでナビを起動します。</p>

      <div class="stack">
        <div class="row" aria-live="polite">
          <span class="badge" id="locState">位置情報: 未取得</span>
          <span class="status" id="statusMsg">端末の位置情報許可をお願いします。</span>
        </div>

        <form id="navForm">
          <input id="destInput" type="text" inputmode="text" autocomplete="postal-code" placeholder="例: 163-8001 または 03-5321-1111 または 吉野家" />
          <button id="goBtn" class="primary" type="submit" disabled>ナビ開始</button>
          <div class="row">
            <label>
              交通手段：
              <select id="mode">
                <option value="driving">車</option>
                <option value="walking">徒歩</option>
                <option value="transit">公共交通</option>
                <option value="bicycling">自転車</option>
              </select>
            </label>
            <label>
              自動起動（可能な場合）
              <input id="autoLaunch" type="checkbox" checked />
            </label>
          </div>
          <div class="hint">入力例: <code>163-8001</code>（郵便番号） / <code>03-5321-1111</code>（お店・施設の電話番号）/ 吉野家(店舗の名前・住所)</div>
        </form>

        <hr />
        <details>
          <summary>うまく開かないとき</summary>
          <ul>
            <li>アプリが未インストールの場合はブラウザ版 Google マップに遷移します。</li>
            <li>ブラウザの仕様上、「完全な自動起動」は制限されるため、<em>ボタン操作</em>が必要な場合があります。</li>
            <li>電話番号は、Google マップに登録されている店舗等のみヒットします（個人番号は検索不可のことがあります）。</li>
          </ul>
        </details>
      </div>

      <p class="footer">© Demo. このページは端末上の位置情報のみを使用し、外部に送信しません。</p>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const locState = $('#locState');
    const statusMsg = $('#statusMsg');
    const form = $('#navForm');
    const input = $('#destInput');
    const goBtn = $('#goBtn');
    const modeSel = $('#mode');
    const autoLaunch = $('#autoLaunch');

    let coords = null; // {lat, lng}
    let platform = detectPlatform();

    // Request location ASAP
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos)=>{
        coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        locState.textContent = '位置情報: 取得済み';
        statusMsg.textContent = `緯度 ${coords.lat.toFixed(5)}, 経度 ${coords.lng.toFixed(5)}`;
        goBtn.disabled = false;
        if (autoLaunch.checked && input.value.trim()) {
          tryStart();
        }
      }, (err)=>{
        locState.textContent = '位置情報: 取得できません';
        statusMsg.textContent = '許可しなくても使えます（現在地は「現在地」に自動設定）。';
        goBtn.disabled = false;
      }, { enableHighAccuracy:true, timeout:8000, maximumAge:60000 });
    } else {
      locState.textContent = '位置情報: 非対応ブラウザ';
      statusMsg.textContent = '現在地は「現在地」に設定されます。';
      goBtn.disabled = false;
    }

input.addEventListener('input', ()=>{
      const val = input.value.trim();
      goBtn.disabled = !val;

      // 入力の自動整形（郵便番号・固定電話）
      const digits = val.replace(/[^0-9]/g,'');

      // 7桁の郵便番号（ハイフンなし）→ XXX-XXXX
      if (digits.length === 7 && !val.includes('-') && !val.includes('番') && !val.includes('府') && !val.includes('県') && !val.includes('都') && !val.includes('市')) {
        input.value = digits.slice(0,3) + '-' + digits.slice(3);
        input.setAttribute("inputmode", "numeric");
        input.type = "tel"; 
        return;
      }

      // 10桁の固定電話（ハイフンなし）→ 03/06 は 2-4-4、それ以外は 3-3-4
      if (digits.length === 10 && val[3] == '-' && !val.includes('番') && !val.includes('府') && !val.includes('県') && !val.includes('都') && !val.includes('市')) {
        digits.slice(0,2) + '-' + digits.slice(4)
        let formatted;
        if (/^0(3|6)/.test(digits)) {
          // 東京・大阪など 03 / 06 → 2-4-4
          formatted = digits.slice(0,2) + '-' + digits.slice(2,6) + '-' + digits.slice(6);
        } else {
          // それ以外は 3-3-4 の一般形
          formatted = digits.slice(0,3) + '-' + digits.slice(3,6) + '-' + digits.slice(6);
        }
        input.value = formatted;
        input.setAttribute("inputmode", "numeric");
        input.type = "tel"; 
        return;
      }
    });

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      tryStart();
    });

    function tryStart(){
      const raw = input.value.trim();
      if (!raw) {
        input.focus();
        statusMsg.textContent = '宛先を入力してください。';
        return;
      }
      const destination = sanitizeDestination(raw);
      const mode = modeSel.value;
      const urls = buildPreferredUrls({ destination, mode, coords, platform });
      openWithFallback(urls.app, urls.web);
    }

 function buildPreferredUrls({ destination, mode, coords, platform }){
   const originParam = coords ? `${coords.lat},${coords.lng}` : 'Current+Location';
   const encodedDest = encodeURIComponent(destination);

   // Web universal URL (works both mobile/desktop)
   const web = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(originParam)}&destination=${encodedDest}&travelmode=${mode}&dir_action=navigate`;

   let app;
   if (platform === 'ios') {
     // iOSはcomgooglemapsスキームでtransit対応
     app = `comgooglemaps://?saddr=${encodeURIComponent(originParam)}&daddr=${encodedDest}&directionsmode=${mode}`;
   } else if (platform === 'android') {
     if (mode === 'transit') {
       // Androidのgoogle.navigationは公共交通非対応→Webにフォールバック
       app = web;
     } else {
       app = `google.navigation:q=${encodedDest}&mode=${modeChar(mode)}`;
     }
   } else {
     app = web;
   }
   return { app, web };
 }

    function openWithFallback(appUrl, webUrl){
      let opened = false;
      const t = setTimeout(()=>{
        if (!opened) window.location.href = webUrl;
      }, 1200);
      try {
        window.location.href = appUrl;
        opened = true;
      } catch(e){
        clearTimeout(t);
        window.location.href = webUrl;
      }
    }

    function sanitizeDestination(val){
      const v = val.replace(/[\u3000]/g,' ').trim();
      const digits = v.replace(/[^0-9]/g,'');
      if (digits.length === 7) {
        return digits.slice(0,3) + '-' + digits.slice(3);
      }
      if (/^-?\d{1,3}\.\d+\s*,\s*-?\d{1,3}\.\d+$/.test(v)) return v;
      if (/^[0-9\-\+\s]{9,}$/.test(v)) return v;
      return v;
    }

    function modeChar(mode){
      switch(mode){
        case 'walking': return 'w';
        case 'bicycling': return 'b';
        case 'transit': return 't';
        default: return 'd';
      }
    }

    function detectPlatform(){
      const ua = navigator.userAgent || '';
      if (/iPhone|iPad|iPod/i.test(ua)) return 'ios';
      if (/Android/i.test(ua)) return 'android';
      return 'other';
    }
  })();
  </script>
</body>
</html>

